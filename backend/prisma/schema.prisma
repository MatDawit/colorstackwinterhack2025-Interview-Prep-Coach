generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider  = "postgresql"
}

model User {
  id           String  @id @default(uuid())
  email        String  @unique
  name         String?
  passwordHash String?

  googleId    String? @unique
  githubId    String? @unique
  githubLogin String?

  bio             String?
  location        String?
  avatarUrl       String?
  avatarShape     String?
  avatarBorder    String?
  darkMode        Boolean @default(false)
  onboardingCompleted Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  resume      Resume?
  sessions    Session[]
  Preferences Preferences?

  @@index([email])
}

model Resume {
  id              String   @id @default(uuid())
  userId          String   @unique
  resumeUrl       String
  resumeFileName  String
  resumeUpdatedAt DateTime @default(now())
  storagePath     String?
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Preferences {
  id                  String   @id @default(uuid())
  userId              String   @unique
  defaultRole         String   @default("Software Engineering")
  defaultDifficulty   String   @default("Basic")
  focusBehavioral     Boolean  @default(true)
  focusTechnical      Boolean  @default(false)
  focusSystemDesign   Boolean  @default(false)
  autoStartNext       Boolean  @default(false)
  feedbackEmphasize   String   @default("Balance")
  feedbackTone        String   @default("Encouraging")
  feedbackDetail      String   @default("Standard")
  showSampleAnswer    Boolean  @default(true)
  enableTimer         Boolean  @default(true)
  countdownSeconds    Int      @default(0)
  autoSubmitOnSilence Boolean  @default(false)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Question {
  id                String           @id @default(uuid())
  category          String
  question          String
  role              String           @default("Software Engineering")
  difficulty        String           @default("Basic")
  focus             String           @default("Behavioral")
  createdAt         DateTime         @default(now())
  currentInSessions Session[]
  attempts          SessionAttempt[]

  @@index([category])
}

model Session {
  id                String           @id @default(uuid())
  userId            String
  interviewType     String
  status            SessionStatus    @default(IN_PROGRESS)
  currentQuestionId String?
  difficulty        String           @default("Basic")
  overallScore      Float?
  totalDuration     Int?
  createdAt         DateTime         @default(now())
  endedAt           DateTime?
  currentQuestion   Question?        @relation(fields: [currentQuestionId], references: [id])
  user              User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  attempts          SessionAttempt[]

  @@index([userId])
}

model SessionAttempt {
  id                 String   @id @default(uuid())
  sessionId          String
  questionId         String
  transcription      String
  audioUrl           String?
  duration           Int?
  score              Int?
  checklist          Json?
  feedback           String?
  improvedVersion    String?
  actionableFeedback String?
  createdAt          DateTime @default(now())
  question           Question @relation(fields: [questionId], references: [id])
  session            Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
}

enum SessionStatus {
  IN_PROGRESS
  COMPLETED
  ABANDONED
}
