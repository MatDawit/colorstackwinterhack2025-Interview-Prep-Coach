// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  //url      = env("DATABASE_URL") //We'll remove it in Prisma 7
}

// --- Enums for session status ---
enum SessionStatus {
  IN_PROGRESS  // User is currently answering
  COMPLETED    // User finished all questions successfully
  ABANDONED    // User clicked away/reset mid-session
}

// User authentication and profile 
model User {
  id            String    @id @default(uuid())
  email         String    @unique 
  name          String
  passwordHash  String
  
  // Profile info
  targetRole    String?   // "Software Engineer Intern", etc.
  experienceLevel String? // "Student", "Entry-level", etc.
  bio             String?
  location        String?
  avatarUrl       String?   // path or URL to avatar image
  avatarShape     String?   // "circle" | "square" (optional)
  avatarBorder    String?   // hex like "#3D7AF5" (optional)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  // attempts      Attempt[]
  //mockInterviews MockInterview[]
  sessions      Session[] // Practice Sessions

  @@index([email])
}

// User's practice attempts
model Attempt {
  id            String    @id @default(uuid())
  userId        String
  questionId    String
  
  // User's response
  transcription String    @db.Text  // Fadlula stores transcribed text here
  audioUrl      String?              // Optional: link to recorded audio
  
  // Matthew's scoring
  starScores    Json?     // { situation: 8.5, task: 7.0, action: 9.2, result: 6.5, overall: 7.8 }
  
  // Fadlulah's AI feedback
  feedback      String?   @db.Text  // Claude's feedback
  biasPatterns  Json?     // { hedging: 3, apologizing: 1, ... }
  
  // Metadata
  duration      Int?      // seconds spent answering
  completedAt   DateTime  @default(now())
  
  // Relations
  // user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  // question      Question  @relation(fields: [questionId], references: [id])
  
  @@index([userId])
  @@index([questionId])
}

// Mock interview sessions
model MockInterview {
  id            String    @id @default(uuid())
  userId        String
  
  // Results
  averageStarScore Float
  questionsCompleted Int
  totalDuration Int       // Total time in seconds
  
  // Summary feedback
  overallFeedback String  @db.Text
  strengths       Json    // ["Good use of specific examples", ...]
  improvements    Json    // ["Add more quantifiable results", ...]
  
  completedAt   DateTime  @default(now())
  
  // user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
}

// Question bank (seeded from JSON)
model Question {
  id            String    @id @default(uuid())
  category      String    // "Teamwork", "Leadership", "Conflict", etc.
  question      String    @db.Text
  role          String    @default("General") // "Software Engineering", "Product Management", or "General"
  
  // For Matthew's scoring reference
  sampleAnswers Json      // Array of sample answers from the JSON
  
  createdAt     DateTime  @default(now())
  
  // Relations
  attempts      SessionAttempt[]
  currentInSessions Session[]
  
  @@index([category])
}

model Session {
  id            String        @id @default(uuid())
  userId        String
  
  // Metadata
  interviewType String        // "Software Engineering", "Product Mgmt"
  status        SessionStatus @default(IN_PROGRESS)
  currentQuestionId String?
  
  // Aggregate Stats (Filled when completed)
  overallScore  Float?        // Average score of attempts
  totalDuration Int?          // Total seconds
  
  createdAt     DateTime      @default(now())
  endedAt       DateTime?

  // Relations
  user          User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  attempts      SessionAttempt[]
  currentQuestion   Question?  @relation(fields: [currentQuestionId], references: [id])

  @@index([userId])
}

model SessionAttempt {
  id            String    @id @default(uuid())
  
  sessionId     String
  questionId    String
  
  // User Content
  transcription String    @db.Text
  audioUrl      String?   
  duration      Int?      // Duration of this specific answer

  // AI Scoring & Feedback
  score         Int?      // 0-100
  checklist     Json?     // { specific_examples: true... }
  feedback      String?   @db.Text
  improvedVersion    String?   @db.Text
  actionableFeedback String?   @db.Text 

  createdAt     DateTime  @default(now())

  // Relations
  session       Session   @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  question      Question  @relation(fields: [questionId], references: [id])

  @@index([sessionId]) 
}